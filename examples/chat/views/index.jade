extend layout

block body
  h1 Real-time Chat
    small With persistent history

  ul#messages

  form
    input(type="text", name="nick", placeholder="Nick", style="width: 80px")
    input(type="text", name="message", placeholder="Enter message")
    button Send

append scripts
  script
    $(function(){
      
      var socket = window.socket;
      var messages = $("#messages");
      socket.on('chat', function(data){
        if (data.message) {
          var dt = new Date(data.time);
          var time = zeroPad(2, dt.getHours())+':'+zeroPad(2, dt.getSeconds());
          var html = '<li><time pubdate datetime="'+dt+'">'+time+"</time> "+
            '<b>'+data.nick+'</b>: '+data.message+"</li>";
          var message = $(html).hide().appendTo(messages);
          message.show("fade");
        }
      });

      socket.on('chatHistory', function(data){
        var html = "";
        $.each(data, function(i, data){
          var dt = new Date(data.time);
          var time = zeroPad(2, dt.getHours())+':'+zeroPad(2, dt.getSeconds());
          html += '<li><time pubdate datetime="'+dt+'">'+time+"</time> "+
            '<b>'+data.nick+'</b>: '+data.message+"</li>";
        });
        messages.append(html);
      });

      $("form").submit(function(e){        
        e.preventDefault();
        var message = $(this).find("input[name=message]");
        var nick = $(this).find("input[name=nick]");
        socket.emit('chat', { nick: nick.val() || 'jdoe', message: message.val(), time: new Date() });
        message.val("").focus();
      });

    });